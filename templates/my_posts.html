{% extends "base.html" %}

{% block title %}My Stories - Opinian{% endblock %}

{% block content %}
<div class="section" style="padding-top: 100px; min-height: 100vh;">
    <div class="container">
        <div class="section-header">
            <h1 class="section-title">
                <i class="fas fa-folder-open"></i> My Stories
            </h1>
            <p class="section-subtitle">
                Manage your published stories and drafts
            </p>
        </div>

        <!-- Quick Actions -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center;">
            <a href="{{ url_for('blog.editor') }}" class="btn btn-primary">
                <i class="fas fa-pen-fancy"></i> Write New Story
            </a>
            <a href="{{ url_for('ai.ai_tools') }}" class="btn btn-secondary">
                <i class="fas fa-robot"></i> AI Assistant
            </a>
        </div>

        <!-- Stats Overview -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
            <div class="card" style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, var(--noir-burgundy) 0%, var(--noir-deep-burgundy) 100%);">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--noir-gold); margin-bottom: 0.5rem;"></i>
                <h3 style="font-size: 2rem; color: var(--noir-cream); margin: 0;">{{ published_count }}</h3>
                <p style="color: var(--noir-light-gray); margin: 0; font-size: 0.9rem;">Published</p>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, var(--noir-dark-gray) 0%, var(--noir-charcoal) 100%);">
                <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--noir-gold); margin-bottom: 0.5rem;"></i>
                <h3 style="font-size: 2rem; color: var(--noir-cream); margin: 0;">{{ draft_count }}</h3>
                <p style="color: var(--noir-light-gray); margin: 0; font-size: 0.9rem;">Drafts</p>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, var(--noir-charcoal) 0%, var(--noir-black) 100%);">
                <i class="fas fa-heart" style="font-size: 2rem; color: var(--noir-gold); margin-bottom: 0.5rem;"></i>
                <h3 style="font-size: 2rem; color: var(--noir-cream); margin: 0;">{{ total_likes }}</h3>
                <p style="color: var(--noir-light-gray); margin: 0; font-size: 0.9rem;">Total Likes</p>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, var(--noir-black) 0%, var(--noir-charcoal) 100%);">
                <i class="fas fa-comment" style="font-size: 2rem; color: var(--noir-gold); margin-bottom: 0.5rem;"></i>
                <h3 style="font-size: 2rem; color: var(--noir-cream); margin: 0;">{{ total_comments }}</h3>
                <p style="color: var(--noir-light-gray); margin: 0; font-size: 0.9rem;">Total Comments</p>
            </div>
        </div>

        <!-- Tabs -->
        <div style="border-bottom: 2px solid var(--noir-gray); margin-bottom: 2rem;">
            <div style="display: flex; gap: 2rem;">
                <button onclick="showTab('published')" id="publishedTab" class="tab-btn active">
                    <i class="fas fa-check-circle"></i> Published ({{ published_count }})
                </button>
                <button onclick="showTab('drafts')" id="draftsTab" class="tab-btn">
                    <i class="fas fa-file-alt"></i> Drafts ({{ draft_count }})
                </button>
            </div>
        </div>

        <!-- Published Posts -->
        <div id="publishedContent" class="tab-content">
            {% if published_posts %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem;">
                {% for post in published_posts %}
                <div class="card" style="display: flex; flex-direction: column; height: 100%; min-height: 380px; position: relative;">
                    <!-- AI Badge -->
                    {% if post.ai_assisted %}
                    <span style="position: absolute; top: 1rem; right: 1rem; background: var(--noir-burgundy); color: var(--noir-gold); padding: 0.25rem 0.75rem; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em; z-index: 10;">
                        <i class="fas fa-robot"></i> AI
                    </span>
                    {% endif %}

                    <!-- Card Title (Fixed Height) -->
                    <h3 class="card-title" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; height: 2.8em; margin-bottom: 1rem;">{{ post.title }}</h3>

                    <!-- Card Content (Fixed Height) -->
                    <div class="card-content" style="color: var(--noir-light-gray); margin-bottom: 1rem; flex: 1; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.6; max-height: 6.4em;">
                        {{ post.content|striptags|truncate(150) }}
                    </div>

                    <!-- Card Footer -->
                    <div style="margin-top: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--noir-gray); margin-bottom: 1rem;">
                            <span style="font-size: 0.85rem; color: var(--noir-light-gray);">
                                <i class="far fa-calendar"></i> {{ post.created_at.strftime('%b %d') }}
                            </span>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--noir-gold);">
                                <span title="{{ post.like_count }} likes"><i class="fas fa-heart"></i> {{ post.like_count }}</span>
                                <span title="{{ post.comment_count }} comments"><i class="fas fa-comment"></i> {{ post.comment_count }}</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <a href="{{ url_for('main.view_post', slug=post.slug) }}" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <a href="{{ url_for('blog.edit_blog', post_id=post.id) }}" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button onclick="deletePost({{ post.id }})" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-book-open" style="font-size: 4rem; color: var(--noir-gray); margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="color: var(--noir-light-gray); margin-bottom: 1rem;">No published stories yet</h3>
                <p style="color: var(--noir-gray); margin-bottom: 2rem;">Share your creativity with the world!</p>
                <a href="{{ url_for('blog.editor') }}" class="btn btn-primary">
                    <i class="fas fa-pen-fancy"></i> Write Your First Story
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Draft Posts -->
        <div id="draftsContent" class="tab-content hidden">
            {% if draft_posts %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem;">
                {% for post in draft_posts %}
                <div class="card" style="display: flex; flex-direction: column; height: 100%; min-height: 380px; position: relative; opacity: 0.9;">
                    <!-- Draft Badge -->
                    <span style="position: absolute; top: 1rem; right: 1rem; background: var(--noir-gray); color: var(--noir-black); padding: 0.25rem 0.75rem; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em; z-index: 10;">
                        DRAFT
                    </span>

                    <!-- Card Title (Fixed Height) -->
                    <h3 class="card-title" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; height: 2.8em; margin-bottom: 1rem;">{{ post.title if post.title else 'Untitled Draft' }}</h3>

                    <!-- Card Content (Fixed Height) -->
                    <div class="card-content" style="color: var(--noir-light-gray); margin-bottom: 1rem; flex: 1; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.6; max-height: 6.4em;">
                        {{ post.content|striptags|truncate(150) if post.content else 'No content yet...' }}
                    </div>

                    <!-- Card Footer -->
                    <div style="margin-top: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--noir-gray); margin-bottom: 1rem;">
                            <span style="font-size: 0.85rem; color: var(--noir-light-gray);">
                                <i class="far fa-clock"></i> {{ post.updated_at.strftime('%b %d') if post.updated_at else post.created_at.strftime('%b %d') }}
                            </span>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <a href="{{ url_for('blog.edit_blog', post_id=post.id) }}" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-edit"></i> Continue
                            </a>
                            <button onclick="publishDraft({{ post.id }})" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-paper-plane"></i> Publish
                            </button>
                            <button onclick="deletePost({{ post.id }})" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-file-alt" style="font-size: 4rem; color: var(--noir-gray); margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="color: var(--noir-light-gray); margin-bottom: 1rem;">No drafts saved</h3>
                <p style="color: var(--noir-gray); margin-bottom: 2rem;">Start writing and save as draft to continue later</p>
                <a href="{{ url_for('blog.editor') }}" class="btn btn-primary">
                    <i class="fas fa-pen-fancy"></i> Start Writing
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .tab-btn {
        background: transparent;
        border: none;
        color: var(--noir-light-gray);
        font-size: 1rem;
        font-weight: 500;
        padding: 1rem 0;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: var(--transition-quick);
    }

    .tab-btn:hover {
        color: var(--noir-cream);
        border-bottom-color: var(--noir-gray);
    }

    .tab-btn.active {
        color: var(--noir-gold);
        border-bottom-color: var(--noir-gold);
    }

    .tab-content {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Tab switching
    function showTab(tab) {
        const publishedContent = document.getElementById('publishedContent');
        const draftsContent = document.getElementById('draftsContent');
        const publishedTab = document.getElementById('publishedTab');
        const draftsTab = document.getElementById('draftsTab');

        if (tab === 'published') {
            publishedContent.classList.remove('hidden');
            draftsContent.classList.add('hidden');
            publishedTab.classList.add('active');
            draftsTab.classList.remove('active');
        } else {
            publishedContent.classList.add('hidden');
            draftsContent.classList.remove('hidden');
            publishedTab.classList.remove('active');
            draftsTab.classList.add('active');
        }
    }

    // Delete post
    function deletePost(postId) {
        if (confirm('Are you sure you want to delete this story? This action cannot be undone.')) {
            fetch(`/blog/delete/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to delete post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete post');
            });
        }
    }

    // Publish draft
    function publishDraft(postId) {
        if (confirm('Are you sure you want to publish this draft?')) {
            fetch(`/blog/publish/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to publish draft');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to publish draft');
            });
        }
    }

    // Animate cards on load
    document.addEventListener('DOMContentLoaded', function() {
        anime({
            targets: '.card',
            opacity: [0, 1],
            translateY: [30, 0],
            duration: 600,
            easing: 'easeOutExpo',
            delay: anime.stagger(100)
        });
    });
</script>
{% endblock %}
