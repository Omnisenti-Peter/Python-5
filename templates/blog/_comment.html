<!-- Single Comment Template (Recursive for nested replies) -->
<div class="comment-item bg-gray-50 rounded-lg p-4" id="comment-{{ comment.id }}">
    <div class="flex items-start space-x-3">
        <!-- Avatar -->
        <div class="flex-shrink-0">
            {% if comment.profile_image_url %}
                <img src="/{{ comment.profile_image_url }}" alt="{{ comment.username }}"
                     class="w-10 h-10 rounded-full object-cover">
            {% else %}
                <div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-black"></i>
                </div>
            {% endif %}
        </div>

        <!-- Comment Content -->
        <div class="flex-1 min-w-0">
            <!-- Header -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-2">
                    <a href="{{ url_for('pages.user_profile', username=comment.username) }}"
                       class="font-semibold text-gray-900 hover:text-yellow-600">
                        {{ comment.first_name }} {{ comment.last_name }}
                    </a>
                    <span class="text-xs text-gray-500">@{{ comment.username }}</span>
                    <span class="text-xs text-gray-400">
                        {{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                    </span>
                    {% if comment.updated_at and comment.updated_at != comment.created_at %}
                        <span class="text-xs text-gray-400 italic">(edited)</span>
                    {% endif %}
                </div>

                <!-- Actions Dropdown -->
                {% if session.get('user_id') %}
                    <div class="relative comment-actions">
                        <button type="button" class="text-gray-400 hover:text-gray-600 p-1"
                                onclick="toggleCommentMenu({{ comment.id }})">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="comment-menu-{{ comment.id }}"
                             class="hidden absolute right-0 mt-1 w-32 bg-white rounded-lg shadow-lg border z-10">
                            {% if session.get('user_id') == comment.user_id or session.get('user_role') in ['SuperAdmin', 'Admin'] %}
                                <button type="button"
                                        onclick="showEditForm({{ comment.id }})"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                            {% endif %}
                            {% if session.get('user_id') == comment.user_id or session.get('user_id') == post.author_id or session.get('user_role') in ['SuperAdmin', 'Admin'] %}
                                <form action="{{ url_for('blog.delete_comment', comment_id=comment.id) }}"
                                      method="POST"
                                      onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                    <button type="submit"
                                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Comment Text -->
            <div id="comment-content-{{ comment.id }}" class="text-gray-700 mb-3 whitespace-pre-wrap">{{ comment.content }}</div>

            <!-- Edit Form (hidden by default) -->
            <form id="edit-form-{{ comment.id }}"
                  action="{{ url_for('blog.edit_comment', comment_id=comment.id) }}"
                  method="POST"
                  class="hidden mb-3">
                <textarea name="content" rows="3"
                          class="vintage-input w-full mb-2"
                          required maxlength="5000">{{ comment.content }}</textarea>
                <div class="flex space-x-2">
                    <button type="submit" class="vintage-button text-sm">
                        <i class="fas fa-save mr-1"></i>Save
                    </button>
                    <button type="button"
                            onclick="hideEditForm({{ comment.id }})"
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        Cancel
                    </button>
                </div>
            </form>

            <!-- Reply Button -->
            {% if session.get('user_id') %}
                <button type="button"
                        onclick="showReplyForm({{ comment.id }})"
                        class="text-sm text-yellow-600 hover:text-yellow-700">
                    <i class="fas fa-reply mr-1"></i>Reply
                </button>

                <!-- Reply Form (hidden by default) -->
                <form id="reply-form-{{ comment.id }}"
                      action="{{ url_for('blog.add_comment', post_id=post.id) }}"
                      method="POST"
                      class="hidden mt-3">
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <textarea name="content" rows="2"
                              class="vintage-input w-full mb-2"
                              placeholder="Write your reply..."
                              required maxlength="5000"></textarea>
                    <div class="flex space-x-2">
                        <button type="submit" class="vintage-button text-sm">
                            <i class="fas fa-paper-plane mr-1"></i>Reply
                        </button>
                        <button type="button"
                                onclick="hideReplyForm({{ comment.id }})"
                                class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Cancel
                        </button>
                    </div>
                </form>
            {% endif %}

            <!-- Nested Replies -->
            {% if comment.replies %}
                <div class="mt-4 pl-4 border-l-2 border-yellow-200 space-y-4">
                    {% for reply in comment.replies %}
                        {% with comment=reply %}
                            {% include 'blog/_comment.html' %}
                        {% endwith %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
