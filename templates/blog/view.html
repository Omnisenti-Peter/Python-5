{% extends "base.html" %}

{% block title %}{{ post.title }} - Opinian{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Article Header -->
                <article class="vintage-card p-8 mb-8">
                    {% if post.featured_image_url %}
                        <div class="mb-6 rounded-lg overflow-hidden">
                            <img src="/{{ post.featured_image_url }}" alt="{{ post.title }}"
                                 class="w-full h-64 object-cover">
                        </div>
                    {% endif %}
                    
                    <!-- Meta Information -->
                    <div class="mb-6">
                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-4">
                            <span>
                                <i class="fas fa-calendar mr-1"></i>
                                {{ post.published_at.strftime('%B %d, %Y') }}
                            </span>
                            <span class="flex items-center">
                                <!-- Author Avatar -->
                                {% if post.profile_image_url %}
                                <img src="/{{ post.profile_image_url }}" alt="{{ post.first_name }}"
                                     class="w-6 h-6 rounded-full object-cover border border-yellow-600 mr-2">
                                {% else %}
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600
                                            flex items-center justify-center border border-yellow-700 mr-2">
                                    <span class="text-xs font-bold text-white">
                                        {{ post.first_name[0].upper() if post.first_name else post.username[0].upper() }}
                                    </span>
                                </div>
                                {% endif %}
                                <a href="{{ url_for('pages.user_profile', username=post.username) }}"
                                   class="text-yellow-600 hover:text-yellow-700">
                                    {{ post.first_name }} {{ post.last_name }}
                                </a>
                            </span>
                            <span>
                                <i class="fas fa-building mr-1"></i>
                                {{ post.group_name }}
                            </span>
                            <span>
                                <i class="fas fa-eye mr-1"></i>
                                {{ post.view_count or 0 }} views
                            </span>
                        </div>
                        
                        {% if post.tags %}
                            <div class="flex flex-wrap gap-2 mb-4">
                                {% for tag in post.tags %}
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">
                                        <i class="fas fa-tag mr-1"></i>{{ tag }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Article Title -->
                    <h1 class="text-4xl font-bold mb-6 flapper-accent" style="font-family: var(--heading-font);">
                        {{ post.title }}
                    </h1>
                    
                    <!-- Article Content -->
                    <div class="prose prose-lg max-w-none">
                        {{ post.content|safe }}
                    </div>
                </article>
                
                <!-- Author Bio -->
                <div class="vintage-card p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4 flapper-accent">
                        <i class="fas fa-user-circle mr-2"></i>About the Author
                    </h3>

                    <div class="flex items-start space-x-4">
                        <!-- Author Profile Image -->
                        {% if post.profile_image_url %}
                        <img src="/{{ post.profile_image_url }}" alt="{{ post.first_name }}"
                             class="w-16 h-16 rounded-full object-cover border-4 border-yellow-600 flex-shrink-0">
                        {% else %}
                        <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center flex-shrink-0 border-4 border-yellow-700">
                            <span class="text-2xl font-bold text-white">
                                {{ post.first_name[0].upper() if post.first_name else post.username[0].upper() }}
                            </span>
                        </div>
                        {% endif %}

                        <div>
                            <h4 class="font-semibold text-lg mb-1">
                                {{ post.first_name }} {{ post.last_name }}
                            </h4>
                            <p class="text-gray-600 mb-2">Member of {{ post.group_name }}</p>
                            <p class="text-gray-700">
                                {% if post.bio %}
                                    {{ post.bio }}
                                {% else %}
                                    Passionate writer sharing insights and stories with the community.
                                {% endif %}
                            </p>

                            <div class="mt-3">
                                <a href="{{ url_for('pages.user_profile', username=post.username) }}"
                                   class="text-yellow-600 hover:text-yellow-700 font-medium">
                                    View Profile <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Related Posts -->
                {% if related_posts %}
                    <div class="vintage-card p-6">
                        <h3 class="text-xl font-bold mb-6 flapper-accent">
                            <i class="fas fa-book-open mr-2"></i>Related Posts
                        </h3>

                        <div class="space-y-4">
                            {% for related_post in related_posts %}
                                <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    {% if related_post.featured_image_url %}
                                        <img src="/{{ related_post.featured_image_url }}" alt="{{ related_post.title }}"
                                             class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                                    {% else %}
                                        <div class="w-16 h-16 bg-yellow-400 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-blog text-black text-xl"></i>
                                        </div>
                                    {% endif %}

                                    <div class="flex-1">
                                        <h4 class="font-semibold mb-1 hover:text-yellow-600 transition-colors">
                                            <a href="{{ url_for('blog.view_post', slug=related_post.slug) }}">
                                                {{ related_post.title }}
                                            </a>
                                        </h4>
                                        <p class="text-sm text-gray-600 mb-2 line-clamp-2">
                                            {{ (related_post.excerpt or related_post.content)|striptags|truncate(100) }}
                                        </p>
                                        <div class="flex items-center text-xs text-gray-500">
                                            <span>{{ related_post.published_at.strftime('%B %d, %Y') }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Comments Section -->
                <div class="vintage-card p-6 mt-8" id="comments">
                    <h3 class="text-xl font-bold mb-6 flapper-accent">
                        <i class="fas fa-comments mr-2"></i>Comments ({{ comment_count or 0 }})
                    </h3>

                    <!-- Add Comment Form -->
                    {% if session.get('user_id') %}
                        <form action="{{ url_for('blog.add_comment', post_id=post.id) }}" method="POST" class="mb-8">
                            <div class="mb-4">
                                <textarea name="content" rows="4"
                                          class="vintage-input w-full"
                                          placeholder="Write your comment..."
                                          required maxlength="5000"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="vintage-button">
                                    <i class="fas fa-paper-plane mr-2"></i>Post Comment
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="bg-gray-100 rounded-lg p-4 mb-8 text-center">
                            <p class="text-gray-600 mb-2">Please log in to leave a comment</p>
                            <a href="{{ url_for('login') }}" class="vintage-button inline-block">
                                <i class="fas fa-sign-in-alt mr-2"></i>Log In
                            </a>
                        </div>
                    {% endif %}

                    <!-- Comments List -->
                    <div class="space-y-6" id="comments-list">
                        {% if comments %}
                            {% for comment in comments %}
                                {% include 'blog/_comment.html' %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-comment-slash text-4xl mb-4"></i>
                                <p>No comments yet. Be the first to comment!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Share Post -->
                <div class="vintage-card p-6">
                    <h3 class="text-lg font-bold mb-4 flapper-accent">
                        <i class="fas fa-share-alt mr-2"></i>Share This Post
                    </h3>
                    
                    <div class="space-y-2">
                        <button class="w-full vintage-button text-sm flex items-center justify-center">
                            <i class="fab fa-twitter mr-2"></i>Twitter
                        </button>
                        <button class="w-full vintage-button text-sm flex items-center justify-center">
                            <i class="fab fa-facebook mr-2"></i>Facebook
                        </button>
                        <button class="w-full vintage-button text-sm flex items-center justify-center">
                            <i class="fab fa-linkedin mr-2"></i>LinkedIn
                        </button>
                        <button id="copy-link" class="w-full vintage-button text-sm flex items-center justify-center">
                            <i class="fas fa-link mr-2"></i>Copy Link
                        </button>
                    </div>
                </div>
                
                <!-- Post Stats -->
                <div class="vintage-card p-6">
                    <h3 class="text-lg font-bold mb-4 flapper-accent">
                        <i class="fas fa-chart-bar mr-2"></i>Post Stats
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Views:</span>
                            <span class="font-bold text-yellow-600">{{ post.view_count or 0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Reading Time:</span>
                            <span class="font-bold text-yellow-600">{{ (post.content|length / 200)|round }} min</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Words:</span>
                            <span class="font-bold text-yellow-600">{{ post.content|length }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Published:</span>
                            <span class="font-bold text-yellow-600">{{ post.published_at.strftime('%b %d') }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Comments:</span>
                            <span class="font-bold text-yellow-600">{{ comment_count or 0 }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Newsletter Signup -->
                <div class="vintage-card p-6">
                    <h3 class="text-lg font-bold mb-4 flapper-accent">
                        <i class="fas fa-envelope mr-2"></i>Stay Updated
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Get notified about new posts from {{ post.group_name }}.
                    </p>
                    
                    <form class="space-y-3">
                        <input type="email" placeholder="your@email.com" 
                               class="vintage-input w-full text-sm">
                        <button type="submit" class="vintage-button w-full text-sm">
                            <i class="fas fa-paper-plane mr-2"></i>Subscribe
                        </button>
                    </form>
                </div>
                
                <!-- Categories -->
                {% if post.tags %}
                    <div class="vintage-card p-6">
                        <h3 class="text-lg font-bold mb-4 flapper-accent">
                            <i class="fas fa-tags mr-2"></i>Categories
                        </h3>
                        
                        <div class="flex flex-wrap gap-2">
                            {% for tag in post.tags %}
                                <a href="{{ url_for('blog.blog_index') }}?tag={{ tag }}" 
                                   class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-yellow-100 hover:text-yellow-800 transition-colors">
                                    {{ tag }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Copy link functionality
    document.getElementById('copy-link').addEventListener('click', function() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(function() {
            // Show success message
            const button = document.getElementById('copy-link');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
            button.classList.add('bg-green-500');

            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-500');
            }, 2000);
        });
    });

    // Social sharing (placeholder)
    document.querySelectorAll('.fa-twitter, .fa-facebook, .fa-linkedin').forEach(icon => {
        icon.parentElement.addEventListener('click', function() {
            alert('Social sharing feature coming soon!');
        });
    });

    // Newsletter subscription
    const newsletterForm = document.querySelector('.vintage-card form[class="space-y-3"]');
    if (newsletterForm) {
        newsletterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = this.querySelector('input[type="email"]').value;
            if (email) {
                alert('Thank you for subscribing! You will receive notifications about new posts.');
                this.reset();
            }
        });
    }

    // Add line clamp utility
    document.querySelectorAll('.line-clamp-2').forEach(el => {
        el.style.display = '-webkit-box';
        el.style.webkitLineClamp = '2';
        el.style.webkitBoxOrient = 'vertical';
        el.style.overflow = 'hidden';
    });

    // Animate article on load
    document.addEventListener('DOMContentLoaded', function() {
        const article = document.querySelector('article');
        if (article) {
            article.style.opacity = '0';
            article.style.transform = 'translateY(20px)';

            setTimeout(() => {
                article.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                article.style.opacity = '1';
                article.style.transform = 'translateY(0)';
            }, 200);
        }

        // Scroll to comment if hash present
        if (window.location.hash && window.location.hash.startsWith('#comment-')) {
            const commentEl = document.querySelector(window.location.hash);
            if (commentEl) {
                setTimeout(() => {
                    commentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    commentEl.classList.add('ring-2', 'ring-yellow-400');
                    setTimeout(() => commentEl.classList.remove('ring-2', 'ring-yellow-400'), 3000);
                }, 500);
            }
        }
    });

    // ============== Comment Functions ==============

    // Toggle comment action menu
    function toggleCommentMenu(commentId) {
        const menu = document.getElementById('comment-menu-' + commentId);
        // Close all other menus
        document.querySelectorAll('[id^="comment-menu-"]').forEach(m => {
            if (m.id !== 'comment-menu-' + commentId) {
                m.classList.add('hidden');
            }
        });
        menu.classList.toggle('hidden');
    }

    // Close menus when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.comment-actions')) {
            document.querySelectorAll('[id^="comment-menu-"]').forEach(m => {
                m.classList.add('hidden');
            });
        }
    });

    // Show reply form
    function showReplyForm(commentId) {
        // Hide all other reply forms
        document.querySelectorAll('[id^="reply-form-"]').forEach(form => {
            form.classList.add('hidden');
        });
        const form = document.getElementById('reply-form-' + commentId);
        form.classList.remove('hidden');
        form.querySelector('textarea').focus();
    }

    // Hide reply form
    function hideReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        form.classList.add('hidden');
        form.querySelector('textarea').value = '';
    }

    // Show edit form
    function showEditForm(commentId) {
        const content = document.getElementById('comment-content-' + commentId);
        const form = document.getElementById('edit-form-' + commentId);
        const menu = document.getElementById('comment-menu-' + commentId);

        content.classList.add('hidden');
        form.classList.remove('hidden');
        menu.classList.add('hidden');
        form.querySelector('textarea').focus();
    }

    // Hide edit form
    function hideEditForm(commentId) {
        const content = document.getElementById('comment-content-' + commentId);
        const form = document.getElementById('edit-form-' + commentId);

        content.classList.remove('hidden');
        form.classList.add('hidden');
    }
</script>
{% endblock %}