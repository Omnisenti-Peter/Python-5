{% extends "base.html" %}

{% block title %}{{ post.title }} - Opinian{% endblock %}

{% block content %}
<div class="section" style="padding-top: 100px; min-height: 100vh;">
    <div class="container" style="max-width: 900px;">
        <!-- Back Button -->
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary" style="margin-bottom: 2rem;">
            <i class="fas fa-arrow-left"></i> Back to Stories
        </a>

        <!-- Post Content -->
        <article class="card" style="padding: 3rem;">
            <!-- Post Header -->
            <header style="margin-bottom: 2rem; border-bottom: 2px solid var(--noir-gold); padding-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h1 style="font-family: var(--font-serif); font-size: 2.5rem; color: var(--noir-gold); margin: 0; flex: 1;">
                        {{ post.title }}
                    </h1>
                    {% if post.ai_assisted %}
                    <span style="background: var(--noir-burgundy); color: var(--noir-gold); padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.05em; white-space: nowrap; margin-left: 1rem;">
                        <i class="fas fa-robot"></i> AI ENHANCED
                    </span>
                    {% endif %}
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; color: var(--noir-light-gray); font-size: 0.95rem;">
                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                        <span>
                            <i class="fas fa-user"></i>
                            <strong style="color: var(--noir-cream);">{{ post.author.username }}</strong>
                        </span>
                        <span>
                            <i class="far fa-calendar"></i>
                            {{ post.created_at.strftime('%B %d, %Y') }}
                        </span>
                        <span>
                            <i class="far fa-clock"></i>
                            {{ (post.content|striptags|wordcount / 200)|round|int }} min read
                        </span>
                    </div>
                    <div style="display: flex; gap: 1rem; color: var(--noir-gold);">
                        <span><i class="fas fa-heart"></i> {{ post.like_count }}</span>
                        <span><i class="fas fa-comment"></i> {{ post.comment_count }}</span>
                    </div>
                </div>
            </header>

            <!-- Post Body -->
            <div class="post-content" style="font-size: 1.1rem; line-height: 1.9; color: var(--noir-cream); margin: 0; padding: 0; white-space: pre-wrap; word-wrap: break-word;">
                {{- post.content|trim|safe -}}
            </div>

            <!-- Post Actions -->
            <div style="display: flex; gap: 1rem; padding-top: 2rem; border-top: 1px solid var(--noir-gray);">
                {% if current_user.is_authenticated %}
                    <button onclick="toggleLike()" id="likeBtn" class="btn {% if user_liked %}btn-primary{% else %}btn-outline{% endif %}" style="flex: 1;">
                        <i class="fas fa-heart"></i> <span id="likeText">{% if user_liked %}Liked{% else %}Like{% endif %}</span> (<span id="likeCount">{{ post.like_count }}</span>)
                    </button>
                    {% if current_user.id == post.user_id %}
                    <a href="{{ url_for('blog.edit_blog', post_id=post.id) }}" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button onclick="deletePost()" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                {% else %}
                    <button onclick="showLoginModal()" class="btn btn-outline" style="flex: 1;">
                        <i class="fas fa-heart"></i> Login to Like
                    </button>
                {% endif %}
            </div>
        </article>

        <!-- Comments Section -->
        <div class="card" style="padding: 2rem; margin-top: 2rem;">
            <h2 style="font-family: var(--font-serif); color: var(--noir-gold); margin-bottom: 1.5rem;">
                <i class="fas fa-comments"></i> Comments ({{ comments|length }})
            </h2>

            {% if current_user.is_authenticated %}
            <!-- Add Comment Form -->
            <form method="POST" action="{{ url_for('comments.add_comment', post_id=post.id) }}" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <textarea name="content"
                              class="form-control"
                              rows="4"
                              placeholder="Share your thoughts on this story..."
                              required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Post Comment
                </button>
            </form>
            {% else %}
            <div style="background: rgba(114, 47, 55, 0.2); border-left: 3px solid var(--noir-burgundy); padding: 1.5rem; margin-bottom: 2rem; text-align: center;">
                <p style="color: var(--noir-light-gray); margin-bottom: 1rem;">
                    Join the conversation! Login to share your thoughts.
                </p>
                <button onclick="showLoginModal()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Comment
                </button>
            </div>
            {% endif %}

            <!-- Comments List -->
            {% if comments %}
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                {% for comment in comments %}
                <div class="comment-item" style="background: rgba(45, 45, 45, 0.3); border-left: 3px solid var(--noir-gold); padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <strong style="color: var(--noir-gold); font-size: 1rem;">
                                <i class="fas fa-user-circle"></i> {{ comment.author.username }}
                            </strong>
                            <span style="color: var(--noir-gray); font-size: 0.85rem; margin-left: 1rem;">
                                <i class="far fa-clock"></i> {{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                            </span>
                        </div>
                        {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user.id == post.user_id) %}
                        <button onclick="deleteComment({{ comment.id }})" class="btn-icon" style="color: var(--noir-gray);">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                    <p style="color: var(--noir-cream); line-height: 1.6; margin: 0;">
                        {{ comment.content }}
                    </p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 3rem 1rem; color: var(--noir-gray);">
                <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .post-content {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }

    .post-content > *:first-child {
        margin-top: 0 !important;
    }

    .post-content h1, .post-content h2, .post-content h3 {
        font-family: var(--font-serif);
        color: var(--noir-gold);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .post-content h1:first-child,
    .post-content h2:first-child,
    .post-content h3:first-child {
        margin-top: 0;
    }

    .post-content p {
        margin-bottom: 1rem;
    }

    .post-content p:first-child {
        margin-top: 0;
    }

    /* Handle contenteditable divs - minimal spacing */
    .post-content div {
        margin-bottom: 0;
    }

    .post-content div:first-child {
        margin-top: 0;
    }

    .post-content br {
        display: block;
        content: " ";
    }

    /* Preserve formatting from editor */
    .post-content b,
    .post-content strong {
        font-weight: 600;
        color: var(--noir-cream);
    }

    .post-content i,
    .post-content em {
        font-style: italic;
    }

    .post-content u {
        text-decoration: underline;
    }

    .post-content s,
    .post-content strike {
        text-decoration: line-through;
    }

    .post-content a {
        color: var(--noir-gold);
        text-decoration: underline;
    }

    .post-content a:hover {
        color: var(--noir-cream);
    }

    .post-content ul, .post-content ol {
        margin-left: 2rem;
        margin-bottom: 1rem;
    }

    .post-content li {
        margin-bottom: 0.5rem;
    }

    .post-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 2rem auto;
        border: 2px solid var(--noir-gray);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: var(--transition-quick);
    }

    .post-content img:hover {
        border-color: var(--noir-gold);
        box-shadow: 0 0 20px var(--noir-gold-glow);
        transform: scale(1.02);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let userLiked = {{ 'true' if user_liked else 'false' }};

    // Toggle like
    function toggleLike() {
        fetch('/blog/like/{{ post.id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userLiked = data.liked;
                const btn = document.getElementById('likeBtn');
                const text = document.getElementById('likeText');
                const count = document.getElementById('likeCount');

                if (userLiked) {
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-primary');
                    text.textContent = 'Liked';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                    text.textContent = 'Like';
                }

                count.textContent = data.like_count;
            } else {
                alert(data.message || 'Failed to update like');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update like');
        });
    }

    // Delete post
    function deletePost() {
        if (confirm('Are you sure you want to delete this story? This action cannot be undone.')) {
            fetch('/blog/delete/{{ post.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ url_for("main.index") }}';
                } else {
                    alert(data.message || 'Failed to delete post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete post');
            });
        }
    }

    // Delete comment
    function deleteComment(commentId) {
        if (confirm('Are you sure you want to delete this comment?')) {
            fetch(`/comment/delete/${commentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to delete comment');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete comment');
            });
        }
    }

    // Animate post content on load
    document.addEventListener('DOMContentLoaded', function() {
        anime({
            targets: 'article',
            opacity: [0, 1],
            translateY: [30, 0],
            duration: 800,
            easing: 'easeOutExpo'
        });
    });
</script>
{% endblock %}
